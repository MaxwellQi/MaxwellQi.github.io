---
layout: post
title: c语言内存管理
description: c语言中的内存管理
category: blog
tag: c语言
---
## 作用域

一个C语言变量的作用域可以是代码块 作用域，函数作用域或者文件作用域。代码块是{}之间的一段代码。

### auto 自动变量

一般情况下代码块内部定义的变量都是自动变量。当然也可以显示的使用auto关键字

### register寄存器变量

通常变量在内存当中，如果能把变量放到CPU的寄存器里面，代码执行效率会更高。

### 代码块作用域的静态变量

静态变量是指内存位置在程序执行期间一直不改变的变量，一个代码块内部的静态变量只能被这个代码块内部访问。

### 代码块作用域外的静态变量

代码块之外的静态变量在程序执行期间一直存在，但只能被定义这个变量的文件访问。

### 全局变量

全局变量的存储方式和静态变量相同，但可以被多个文件访问。

## 内存四区

程序加载到内存之后，在内存中存放的位置根据代码类型而不同。把内存分为四个区域：

* 代码区：代码区的地址可以通过函数指针来访问。程序当中所有可执行代码都放在代码区。代码区不可读写，只可执行。
* 静态区：存放全局变量和静态变量
* 栈区：所有自动变量，包括函数的形参都放在栈区
* 堆区: 堆是个大容器，程序自由的在堆中放任何变量。

### 代码区

代码区code，程序被操作系统加载到内存的时候，所有的可执行代码都加载到代码区，也叫代码段，这块内存是不可以在运行期间修改的。

### 栈区

栈stack是一种先进后出的内存结构，所有的自动变量，函数的形参都是由编译器自动放出栈中，当一个自动变量超出其作用域时，自动从栈中弹出。

### 堆区

堆heap和栈一样，也是一种在程序运行过程中可以随时修改的内存区域，但没有栈那样先进后出的顺序。

堆是一个大容器，它的容量要远远大于栈，但是在C语言中，堆内存空间的申请和释放需要手动通过代码来完成。


## 示例


### 示例01

```
#include <stdio.h>
#include <Windows.h>

#define MAXSIZE 1024

#pragma warning(disable:4996)

char *test01()
{
    char *str[10] = {"hello"};  // str 是在栈中，出作用域之后变量释放
    return str;
}

char *test02()
{
    return "hello";
}
```

在主函数中执行上述两个函数。

```
int main(){
    char *p1 = test01();
    printf("%s\n",p1);   // 输出随机值
    
    char *p2 = test02();
    printf("%s\n",p2);   // 正确输出 hello
    return 0;
}
```

### 示例02

```

#include <stdio.h>
#include <Windows.h>

#define MAXSIZE 1024

#pragma warning(disable:4996)

char *test03()
{
    char *s = malloc(sizeof(char) * 10);
    strcpy(s,"hello");
    return s;
}

void test04(char *p)
{
	p = malloc(sizeof(char) * 10);
	strcpy(p,"hello");
}


void test05(char *p)
{
	strcpy(p,"hello");
}

void test06(char **p)
{
	*p = malloc(sizeof(char) * 10);
	strcpy(*p,"hello");
}

```

在主函数中执行上述两个函数：

```
int main(){
    char *p3 = test03();
    printf("%s\n", p3);
    free(p3);        //  输出 hello
    
    
    
	char *s = NULL;
	test04(s);
	printf("%s\n",s);  // NULL
	

	char *s2 = malloc(sizeof(char) * 10);
	test05(s2);
	printf("%s\n",s2);   // 可以成功


	char *s = NULL;
	test06(&s);
	printf("%s\n",s);  // 输出hello
	
    
    return 0;
}
```


